<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>にゃんこ大戦争風タワーディフェンス</title>
<style>
  body { margin: 0; background: #f0f0f0; font-family: sans-serif; user-select:none; }
  #game {
    position: relative; width: 900px; height: 400px; margin: 20px auto; background: #a3d9ff; border: 2px solid #333;
    overflow: hidden;
  }
  #battlefield {
    position: relative; width: 100%; height: 320px; background: #d4f0c0; overflow: hidden;
  }
  #castle {
    position: absolute; left: 0; bottom: 0; width: 80px; height: 320px;
    background: url('https://i.imgur.com/M8AHPZL.png') no-repeat center/contain;
    border-right: 3px solid #555;
  }
  #enemy-container, #ally-container {
    position: absolute; bottom: 0; left: 100px; right: 0; height: 320px; overflow: visible;
  }
  .enemy, .ally {
    position: absolute; bottom: 0; width: 50px; height: 50px; border-radius: 8px;
    text-align: center; font-weight: bold; color: white; line-height: 50px; user-select:none;
  }
  .enemy {
    background-color: #e04a4a;
  }
  .ally {
    background-color: #4a90e0;
  }
  #ui {
    width: 900px; margin: 10px auto; display: flex; justify-content: space-between; align-items: center;
  }
  #cost {
    font-size: 20px; font-weight: bold;
  }
  #characters {
    display: flex; gap: 10px;
  }
  .char-btn {
    background: #eee; border: 1px solid #888; border-radius: 6px; padding: 8px 12px; cursor: pointer;
    user-select:none;
    transition: background 0.3s;
  }
  .char-btn:disabled {
    background: #bbb;
    cursor: not-allowed;
  }
</style>
</head>
<body>
  <div id="game">
    <div id="battlefield">
      <div id="castle" title="味方の城"></div>
      <div id="enemy-container"></div>
      <div id="ally-container"></div>
    </div>
    <div id="ui">
      <div id="cost">コスト: 100</div>
      <div id="characters"></div>
      <div id="castle-hp" style="font-weight:bold;">城HP: 1000</div>
    </div>
  </div>

<script>
(async function(){
  // JSON読み込み
  const status = await fetch('/data/status.json').then(r=>r.json());
  const status2 = await fetch('/data/status2.json').then(r=>r.json());
  const stageData = await fetch('/data/Stage.json').then(r=>r.json());
  const gacha = await fetch('/data/gacha.json').then(r=>r.json());
  const charactersData = await fetch('/data/characters.json').then(r=>r.json());
  const enemiesData = await fetch('/data/enemies.json').then(r=>r.json());

  // 初期化
  let cost = 100;
  const maxCost = 1000;
  const costIncreaseInterval = 1000; // 1秒で増えるコスト量
  const costIncreaseAmount = 5;

  let castleHp = 1000;

  const enemyContainer = document.getElementById('enemy-container');
  const allyContainer = document.getElementById('ally-container');
  const costEl = document.getElementById('cost');
  const castleHpEl = document.getElementById('castle-hp');
  const charactersEl = document.getElementById('characters');

  // キャラボタン作成
  charactersData.characters.forEach(char=>{
    const btn = document.createElement('button');
    btn.className = 'char-btn';
    btn.textContent = `${char.name} (${char.stats.cost})`;
    btn.title = char.description;
    btn.disabled = char.stats.cost > cost;
    btn.onclick = () => {
      if(cost < char.stats.cost) return;
      cost -= char.stats.cost;
      updateCost();
      spawnAlly(char);
      updateButtons();
    };
    charactersEl.appendChild(btn);
    char.btn = btn;
  });

  function updateButtons(){
    charactersData.characters.forEach(char=>{
      char.btn.disabled = char.stats.cost > cost;
    });
  }

  function updateCost(){
    costEl.textContent = `コスト: ${cost}`;
  }

  function updateCastleHp(){
    castleHpEl.textContent = `城HP: ${castleHp}`;
  }

  // 味方キャラ出撃処理
  function spawnAlly(char){
    const elem = document.createElement('div');
    elem.className = 'ally';
    elem.textContent = char.name;
    elem.style.left = '0px';
    elem.dataset.hp = char.stats.hp;
    elem.dataset.attack = char.stats.attack;
    elem.dataset.speed = char.stats.speed;
    elem.dataset.cost = char.stats.cost;
    elem.dataset.productionTime = char.stats.productionTime;
    elem.dataset.id = char.id;
    elem.dataset.posX = 0;

    allyContainer.appendChild(elem);
  }

  // 敵管理
  let enemies = [];
  function spawnEnemy(enemyId){
    const enemy = enemiesData.enemies.find(e=>e.id === enemyId);
    if(!enemy) return;
    const elem = document.createElement('div');
    elem.className = 'enemy';
    elem.textContent = enemy.name;
    elem.dataset.hp = enemy.stats.hp;
    elem.dataset.attack = enemy.stats.attack;
    elem.dataset.speed = enemy.stats.speed;
    elem.dataset.id = enemy.id;
    elem.dataset.posX = 850; // 右端スタート

    enemyContainer.appendChild(elem);
    enemies.push(elem);
  }

  // ステージはとりあえず一つ目を使う
  const stage = stageData.stages[0];

  // 敵の自動出現
  let enemyTimer = 0;
  const enemyInterval = stage.enemyProduction.interval;

  // ゲームループ
  function gameLoop(timestamp=0){
    // 敵出現処理
    enemyTimer += 16;
    if(enemyTimer >= enemyInterval){
      spawnEnemy(stage.enemyProduction.enemyId);
      enemyTimer = 0;
    }

    // 味方移動・攻撃処理
    const allies = [...allyContainer.children];
    allies.forEach(ally => {
      let posX = parseFloat(ally.dataset.posX);
      const speed = parseFloat(ally.dataset.speed);

      posX += speed * 0.5;
      if(posX > 850) posX = 850;
      ally.dataset.posX = posX;
      ally.style.left = posX + 'px';

      // 近くの敵を探して攻撃
      enemies.forEach(enemy => {
        const enemyPosX = parseFloat(enemy.dataset.posX);
        if(enemyPosX - posX < 60 && enemyPosX - posX >= 0){
          // 攻撃
          const enemyHp = parseFloat(enemy.dataset.hp);
          const attack = parseFloat(ally.dataset.attack);
          const newHp = enemyHp - attack * 0.1;
          enemy.dataset.hp = newHp;

          // 敵HP表示の色変え（赤くする）
          enemy.style.backgroundColor = `rgba(224,74,74,${Math.max(newHp / enemyHp, 0.1)})`;

          if(newHp <= 0){
            enemy.remove();
            enemies = enemies.filter(e => e !== enemy);
          }
        }
      });
    });

    // 敵移動・攻撃処理
    enemies.forEach(enemy => {
      let posX = parseFloat(enemy.dataset.posX);
      const speed = parseFloat(enemy.dataset.speed);
      posX -= speed * 0.5;
      enemy.dataset.posX = posX;
      enemy.style.left = posX + 'px';

      // 城に到達したらダメージ
      if(posX <= 80){
        castleHp -= parseFloat(enemy.dataset.attack);
        updateCastleHp();
        enemy.remove();
        enemies = enemies.filter(e => e !== enemy);
      }
    });

    // コスト自動回復
    cost += costIncreaseAmount * (16 / costIncreaseInterval);
    if(cost > maxCost) cost = maxCost;
    updateCost();
    updateButtons();

    // ゲームオーバー判定
    if(castleHp <= 0){
      alert("ゲームオーバー！城が壊された！");
      location.reload();
      return;
    }

    requestAnimationFrame(gameLoop);
  }
  updateCost();
  updateCastleHp();
  updateButtons();
  requestAnimationFrame(gameLoop);
})();
</script>

</body>
</html>